<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blogger Registration</title>
  <link rel="stylesheet" href="style.css"/>
  <meta name="description" content="A community-driven platform for free speech, powered by IPFS." />
  <meta name="robots" content="index, follow" />

  <!-- Optional: Cache control (not fully guaranteed) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Open Graph for social previews (optional) -->
  <meta property="og:title" content="Rosebud World" />
  <meta property="og:description" content="A community-driven platform for free speech, powered by IPFS." />
  <meta property="og:image" content="https://rosebud.world/images/preview.jpg" />
  <meta property="og:url" content="https://rosebud.world" />

  <!-- Twitter Card (optional) -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Rosebud World" />
  <meta name="twitter:description" content="A community-driven platform for free speech, powered by IPFS." />
  <meta name="twitter:image" content="https://rosebud.world/images/preview.jpg" />
  <style>
    .form-container {
      max-width: 600px;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      font-weight: bold;
      display: block;
      margin-bottom: 0.5rem;
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button[type="submit"],
    button[type="button"] {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #statusMessage {
      margin-top: 1rem;
      text-align: center;
      font-weight: bold;
    }
    /* Read-only textareas for keys */
    textarea[readonly] {
      background-color: #f9f9f9;
    }
    .key-info {
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>
  <header>
    <h1>Blogger Registration Form</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="articles.html">Articles</a> |
      <a href="guidelines.html">Guidelines</a> |
      <a href="blogger_registration_form.html" class="underline-bold">Registration</a> |
      <a href="submit.html">Submit</a> |
      <a href="encrypt.html">Submit via IPFS</a> |
      <a href="ipfs.html">IPFS</a>
    </nav>
  </header>
  
  <main>
    <section>
      <div class="form-container">
        <p>Registration is optional but strongly advised even if you plan to post anonymously. You are not required to provide any Personal Identifiable Information (PII) for registration.</p>
        <p>Registering ensures that no one later can submit articles under your blogger handle, it ensures you protect the the credibility of your blogger handle and posts.</p>
        <p></p>
        <p style="color: red; font-weight: bold;">Please backup and keep your key pair since this is what controls your account. If you lose this then we will not be able to restore to you control of your account!</p>
        <form id="bloggerForm">
          <div class="form-group">
            <label>Username: 
              <input type="text" name="username" required />
            </label>
          </div>
          <!-- Public key display -->
          <div class="form-group">
            <label>Your Public Key:</label>
            <textarea id="generatedPubKey" readonly required></textarea>
          </div>
          <div class="key-info">
            Your public key has been autoâ€‘generated (or imported). It will be submitted as part of your profile.
          </div>
          <!-- Private key backup display -->
          <div class="form-group">
            <label>Backup Your Private Key (save this somewhere safe):
              <textarea id="backupPrivKey" readonly required></textarea>
            </label>
          </div>
          <div class="key-info">
            Your private key is shown above for backup purposes only. It is also stored locally in your browser.
          </div>
          <!-- Export Key Pair -->
          <div class="form-group">
            <button type="button" id="exportKeysButton">Export Key Pair</button>
          </div>
          <div class="key-info">
            Click the button above to download your key pair as a JSON file.
          </div>
          <!-- Import Section -->
          <div class="form-group">
            <label>Import Your Existing Key Pair (JSON format):</label>
            <textarea id="importKeys" placeholder='Paste your key pair JSON here (e.g., {"publicKey": {...}, "privateKey": {...}})'></textarea>
            <button type="button" id="importKeysButton">Use Imported Key Pair</button>
          </div>
          <div class="key-info">
            If you have an existing key pair, paste it above and click "Use Imported Key Pair". Otherwise, a new key pair is generated automatically.
          </div>
          <!-- Other profile fields -->
          <div class="form-group">
            <label>Bio:
              <textarea name="bio" rows="3"></textarea>
            </label>
          </div>
          <div class="form-group">
            <label>Profile Picture (URL or IPFS):
              <input type="text" name="profile_pic" />
            </label>
          </div>
          <div class="form-group">
            <label>Twitter:
              <input type="text" name="twitter" />
            </label>
          </div>
          <div class="form-group">
            <label>Nostr:
              <input type="text" name="nostr" />
            </label>
          </div>
          <div class="form-group">
            <label>Mastodon:
              <input type="text" name="mastodon" />
            </label>
          </div>
          <div class="form-group">
            <label>BTC Wallet:
              <input type="text" name="btc" />
            </label>
          </div>
          <div class="form-group">
            <label>ETH Wallet:
              <input type="text" name="eth" />
            </label>
          </div>
          <div class="form-group">
            <label>SOL Wallet:
              <input type="text" name="sol" />
            </label>
          </div>
          <div class="form-group">
            <label>XMR Wallet:
              <input type="text" name="xmr" />
            </label>
          </div>
          <div class="form-group">
            <label>ZEC Wallet:
              <input type="text" name="zec" />
            </label>
          </div>
          <div class="form-group">
            <button type="submit">Submit Blogger Profile</button>
          </div>
        </form>
        <p id="statusMessage"></p>
      </div>
    </section>
  </main>

  <script src="https://libraries.projects.cavi.au.dk/javascript/matrix-js-sdk/23.2.0/browser-matrix.min.js"></script>
  <script src="libs/olm.js"></script>

  <script type="module">
    document.addEventListener("DOMContentLoaded", async () => {
      // Initialize Olm
      if (typeof Olm === "undefined") {
        console.error("Olm library failed to load.");
        return;
      }
      await Olm.init();
      console.log("Olm initialized.");

      // Function to update displayed keys and save them to localStorage
      function updateKeys(pubKey, privKey) {
        const pubKeyStr = JSON.stringify(pubKey, null, 2);
        const privKeyStr = JSON.stringify(privKey, null, 2);
        document.getElementById("generatedPubKey").value = pubKeyStr;
        document.getElementById("backupPrivKey").value = privKeyStr;
        localStorage.setItem("userPublicKey", pubKeyStr);
        localStorage.setItem("userPrivateKey", privKeyStr);
      }

      // Check if a key pair exists in localStorage; if not, generate a new one
      let storedPubKey = localStorage.getItem("userPublicKey");
      let storedPrivKey = localStorage.getItem("userPrivateKey");
      if (storedPubKey && storedPrivKey) {
        try {
          storedPubKey = JSON.parse(storedPubKey);
          storedPrivKey = JSON.parse(storedPrivKey);
          updateKeys(storedPubKey, storedPrivKey);
          console.log("Loaded key pair from localStorage.");
        } catch (e) {
          console.error("Error parsing stored keys, generating new key pair.", e);
        }
      } else {
        try {
          const keyPair = await window.crypto.subtle.generateKey(
            {
              name: "RSASSA-PKCS1-v1_5",
              modulusLength: 2048,
              publicExponent: new Uint8Array([1, 0, 1]),
              hash: "SHA-256"
            },
            true,
            ["sign", "verify"]
          );
          const publicKeyJwk = await window.crypto.subtle.exportKey("jwk", keyPair.publicKey);
          const privateKeyJwk = await window.crypto.subtle.exportKey("jwk", keyPair.privateKey);
          updateKeys(publicKeyJwk, privateKeyJwk);
          console.log("Generated new key pair.");
        } catch (e) {
          console.error("Key generation failed:", e);
        }
      }

      // --- Export Key Pair Button Handler ---
      document.getElementById("exportKeysButton").addEventListener("click", () => {
        const pubKeyStr = localStorage.getItem("userPublicKey");
        const privKeyStr = localStorage.getItem("userPrivateKey");
        if (!pubKeyStr || !privKeyStr) {
          alert("No key pair available to export.");
          return;
        }
        const exportData = JSON.stringify({
          publicKey: JSON.parse(pubKeyStr),
          privateKey: JSON.parse(privKeyStr)
        }, null, 2);
        const blob = new Blob([exportData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "keypair.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      // --- Import Key Pair Button Handler ---
      document.getElementById("importKeysButton").addEventListener("click", () => {
        const importArea = document.getElementById("importKeys");
        const importedText = importArea.value.trim();
        if (!importedText) {
          alert("Please paste your key pair JSON in the import field.");
          return;
        }
        try {
          const importedKeys = JSON.parse(importedText);
          if (importedKeys.publicKey && importedKeys.privateKey) {
            updateKeys(importedKeys.publicKey, importedKeys.privateKey);
            alert("Imported key pair successfully.");
          } else {
            alert("Invalid key pair format. Please include both publicKey and privateKey.");
          }
        } catch (e) {
          console.error("Error importing key pair:", e);
          alert("Error importing key pair. Please ensure it's valid JSON.");
        }
      });

      // --- Populate Fields from bloggers.json if a Matching Public Key Is Found ---
      async function populateFromBloggersJson() {
        try {
          const response = await fetch("bloggers.json");
          if (!response.ok) throw new Error("Failed to fetch bloggers.json");
          const bloggers = await response.json();
          const localPubKey = JSON.parse(localStorage.getItem("userPublicKey"));
          if (!localPubKey || !localPubKey.n) return;
          const localModulus = localPubKey.n;
          for (const username in bloggers) {
            const blogger = bloggers[username];
            // Check if blogger.pubkey exists and has an "n" property to compare.
            if (blogger.pubkey && blogger.pubkey.n === localModulus) {
              // Populate the fields with the blogger's data.
              document.querySelector('input[name="username"]').value = username;
              document.querySelector('textarea[name="bio"]').value = blogger.bio;
              document.querySelector('input[name="profile_pic"]').value = blogger.profile_pic;
              document.querySelector('input[name="twitter"]').value = blogger.socials.twitter;
              document.querySelector('input[name="nostr"]').value = blogger.socials.nostr;
              document.querySelector('input[name="mastodon"]').value = blogger.socials.mastodon;
              document.querySelector('input[name="btc"]').value = blogger.wallets.btc;
              document.querySelector('input[name="eth"]').value = blogger.wallets.eth;
              document.querySelector('input[name="sol"]').value = blogger.wallets.sol;
              document.querySelector('input[name="xmr"]').value = blogger.wallets.xmr;
              document.querySelector('input[name="zec"]').value = blogger.wallets.zec;
              console.log("Populated form fields from bloggers.json for:", username);
              break;
            }
          }
        } catch (err) {
          console.error("Error populating from bloggers.json:", err);
        }
      }
      // Call the function to populate fields.
      populateFromBloggersJson();

      // --- Matrix Client Setup ---
      const homeserverUrl = "https://matrix.org";
      const userId = "@rosebud1:matrix.org";
      const accessToken = "syt_cm9zZWJ1ZDE_paIOyAvfPWeGbPsbtzrI_0bDq7k";
      const bloggerRoomId = "!IfayqEDzJhwGSTvAZO:matrix.org"; // Replace with actual room ID

      const matrixClient = matrixcs.createClient({
        baseUrl: homeserverUrl,
        accessToken,
        userId,
        deviceId: "rosebud_blogger_client"
      });

      await matrixClient.initCrypto();
      matrixClient.startClient({ initialSyncLimit: 10 });

      matrixClient.once("sync", (state) => {
        if (state === "PREPARED") {
          console.log("Matrix client ready.");
          // Use the stored public key from localStorage for submission
          enableFormSubmission(matrixClient, JSON.parse(localStorage.getItem("userPublicKey")));
        }
      });

      function enableFormSubmission(client, pubkey) {
        const form = document.getElementById("bloggerForm");
        const statusMessage = document.getElementById("statusMessage");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          statusMessage.textContent = "Submitting...";

          const formData = Object.fromEntries(new FormData(form).entries());
          const submission = {
            username: formData.username,
            pubkey: pubkey, // Stored public key (as a JWK object)
            bio: formData.bio,
            profile_pic: formData.profile_pic,
            socials: {
              twitter: formData.twitter,
              nostr: formData.nostr,
              mastodon: formData.mastodon
            },
            wallets: {
              btc: formData.btc,
              eth: formData.eth,
              sol: formData.sol,
              xmr: formData.xmr,
              zec: formData.zec
            },
            last_updated: new Date().toISOString()
          };

          try {
            await matrixClient.sendEvent(bloggerRoomId, "m.room.message", {
              msgtype: "m.text",
              body: "New Blogger Registration Submission",
              "rosebud:blogger_submission": submission
            });
            statusMessage.textContent = "Submitted successfully!";
            form.reset();
          } catch (err) {
            console.error(err);
            statusMessage.textContent = "Submission failed: " + err.message;
          }
        });
      }
    });
  </script>
</body>
</html>
